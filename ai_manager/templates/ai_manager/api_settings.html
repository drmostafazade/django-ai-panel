{% extends "base.html" %}

{% block title %}ØªÙ†Ø¸ÛŒÙ…Ø§Øª API - Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª{% endblock %}

{% block content %}
<h1 class="page-title mb-4">ØªÙ†Ø¸ÛŒÙ…Ø§Øª API Keys</h1>

<div class="row">
    <div class="col-md-8">
        <!-- ÙØ±Ù… Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† API Key -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† API Key Ø¬Ø¯ÛŒØ¯</h5>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'api_settings' %}" id="apiKeyForm">
                    {% csrf_token %}
                    
                    <!-- Ù…Ø±Ø­Ù„Ù‡ 1: Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø±ÙˆÛŒØ³ -->
                    <div class="mb-3">
                        <label class="form-label">1. Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø±ÙˆÛŒØ³ AI</label>
                        <select name="provider" id="provider" class="form-select" required>
                            <option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ --</option>
                            {% for provider in providers %}
                            <option value="{{ provider.id }}" data-name="{{ provider.name }}">
                                {{ provider.get_name_display }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Ù…Ø±Ø­Ù„Ù‡ 2: ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† API Key -->
                    <div class="mb-3" id="apiKeySection" style="display: none;">
                        <label class="form-label">2. API Key</label>
                        <div class="input-group">
                            <input type="text" name="api_key" id="api_key" class="form-control" 
                                   placeholder="sk-..." required>
                            <button type="button" class="btn btn-outline-secondary" onclick="fetchModels()">
                                <i class="bi bi-download"></i> Ø¯Ø±ÛŒØ§ÙØª Ù…Ø¯Ù„â€ŒÙ‡Ø§
                            </button>
                        </div>
                        <small class="text-muted">Ø§Ø¨ØªØ¯Ø§ API Key Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ØŒ Ø³Ù¾Ø³ Ø¯Ú©Ù…Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ù…Ø¯Ù„â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯</small>
                    </div>
                    
                    <!-- Ù…Ø±Ø­Ù„Ù‡ 3: Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø¯Ù„ -->
                    <div class="mb-3" id="modelSection" style="display: none;">
                        <label class="form-label">3. Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø¯Ù„</label>
                        <select name="model_name" id="model_name" class="form-select" required>
                            <option value="">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</option>
                        </select>
                        <div id="modelInfo" class="small text-muted mt-1"></div>
                    </div>
                    
                    <!-- ÙˆØ¶Ø¹ÛŒØª Ø§ØªØµØ§Ù„ -->
                    <div id="connectionStatus" class="alert d-none mb-3">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2 d-none" id="testingSpinner"></div>
                            <span id="statusText"></span>
                        </div>
                        <div id="usageInfo" class="mt-2 small"></div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-secondary" onclick="testConnection()" 
                                id="testBtn" style="display: none;">
                            <i class="bi bi-plug"></i> ØªØ³Øª Ø§ØªØµØ§Ù„
                        </button>
                        <button type="submit" class="btn btn-primary" id="saveBtn" disabled>
                            <i class="bi bi-save"></i> Ø°Ø®ÛŒØ±Ù‡ API Key
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Ù„ÛŒØ³Øª API Keys -->
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0">API Keys Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡</h5>
            </div>
            <div class="card-body">
                {% if user_keys %}
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Ø³Ø±ÙˆÛŒØ³</th>
                                <th>Ù…Ø¯Ù„</th>
                                <th>ÙˆØ¶Ø¹ÛŒØª</th>
                                <th>Ù…ØµØ±Ù ØªÙˆÚ©Ù†</th>
                                <th>Ø¢Ø®Ø±ÛŒÙ† Ø§Ø³ØªÙØ§Ø¯Ù‡</th>
                                <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for key in user_keys %}
                            <tr>
                                <td>{{ key.provider.get_name_display }}</td>
                                <td>
                                    <code class="small">{{ key.model_name|default:"-" }}</code>
                                </td>
                                <td>
                                    {% if key.is_active %}
                                        {% if key.is_verified %}
                                        <span class="badge bg-success">âœ“ ÙØ¹Ø§Ù„</span>
                                        {% else %}
                                        <span class="badge bg-warning">âš  ØªØ³Øª Ù†Ø´Ø¯Ù‡</span>
                                        {% endif %}
                                    {% else %}
                                    <span class="badge bg-secondary">ØºÛŒØ±ÙØ¹Ø§Ù„</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small>
                                        {% if key.total_tokens > 0 %}
                                        {{ key.used_tokens|floatformat:0 }} / {{ key.total_tokens|floatformat:0 }}
                                        {% else %}
                                        {{ key.used_tokens|floatformat:0 }} ØªÙˆÚ©Ù†
                                        {% endif %}
                                    </small>
                                </td>
                                <td>
                                    <small>{{ key.last_used|date:"Y/m/d H:i"|default:"Ù‡Ø±Ú¯Ø²" }}</small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button onclick="retestKey({{ key.id }})" class="btn btn-outline-info">
                                            ØªØ³Øª
                                        </button>
                                        <form method="post" action="{% url 'toggle_api_key' %}" style="display: inline;">
                                            {% csrf_token %}
                                            <input type="hidden" name="key_id" value="{{ key.id }}">
                                            <button type="submit" class="btn btn-outline-primary">
                                                {% if key.is_active %}ØºÛŒØ±ÙØ¹Ø§Ù„{% else %}ÙØ¹Ø§Ù„{% endif %}
                                            </button>
                                        </form>
                                        <form method="post" action="{% url 'delete_api_key' %}" 
                                              style="display: inline;" 
                                              onsubmit="return confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ');">
                                            {% csrf_token %}
                                            <input type="hidden" name="key_id" value="{{ key.id }}">
                                            <button type="submit" class="btn btn-outline-danger">
                                                Ø­Ø°Ù
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center py-4">Ù‡Ù†ÙˆØ² API Key Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Ù…ØµØ±Ù Ú©Ù„ÛŒ -->
        <div class="card mb-3">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">ğŸ“Š Ø¢Ù…Ø§Ø± Ù…ØµØ±Ù Ø§ÛŒÙ† Ù…Ø§Ù‡</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4>{{ total_tokens_month|default:"0"|floatformat:0 }}</h4>
                        <small class="text-muted">ØªÙˆÚ©Ù† Ù…ØµØ±ÙÛŒ</small>
                    </div>
                    <div class="col-6">
                        <h4>${{ total_cost_month|default:"0"|floatformat:2 }}</h4>
                        <small class="text-muted">Ù‡Ø²ÛŒÙ†Ù‡ ØªÙ‚Ø±ÛŒØ¨ÛŒ</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Ø±Ø§Ù‡Ù†Ù…Ø§ -->
        <div class="card">
            <div class="card-header bg-light">
                <h6 class="mb-0">ğŸ“– Ø±Ø§Ù‡Ù†Ù…Ø§</h6>
            </div>
            <div class="card-body small">
                <h6>Ù…Ø±Ø§Ø­Ù„ ØªÙ†Ø¸ÛŒÙ…:</h6>
                <ol class="ps-3">
                    <li>Ø³Ø±ÙˆÛŒØ³ AI Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</li>
                    <li>API Key Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</li>
                    <li>Ø¯Ú©Ù…Ù‡ "Ø¯Ø±ÛŒØ§ÙØª Ù…Ø¯Ù„â€ŒÙ‡Ø§" Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯</li>
                    <li>Ù…Ø¯Ù„ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</li>
                    <li>ØªØ³Øª Ø§ØªØµØ§Ù„ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯</li>
                    <li>Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯</li>
                </ol>
                
                <div class="alert alert-warning mt-3 py-2">
                    <strong>âš ï¸ Ø§Ù…Ù†ÛŒØª:</strong>
                    <ul class="mb-0 ps-3">
                        <li>API Key Ø±Ø§ Ù…Ø­Ø±Ù…Ø§Ù†Ù‡ Ù†Ú¯Ù‡ Ø¯Ø§Ø±ÛŒØ¯</li>
                        <li>Ø§Ø² Ø§Ø´ØªØ±Ø§Ú© Ú¯Ø°Ø§Ø±ÛŒ Ø¢Ù† Ø®ÙˆØ¯Ø¯Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯</li>
                        <li>Ø¯Ø± ØµÙˆØ±Øª Ù„Ùˆ Ø±ÙØªÙ†ØŒ ÙÙˆØ±Ø§Ù‹ ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Ù†Ù…Ø§ÛŒØ´ Ø¨Ø®Ø´â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ù†ØªØ®Ø§Ø¨
document.getElementById('provider').addEventListener('change', function() {
    const apiKeySection = document.getElementById('apiKeySection');
    const modelSection = document.getElementById('modelSection');
    const testBtn = document.getElementById('testBtn');
    
    if (this.value) {
        apiKeySection.style.display = 'block';
        modelSection.style.display = 'none';
        testBtn.style.display = 'none';
        document.getElementById('saveBtn').disabled = true;
    } else {
        apiKeySection.style.display = 'none';
        modelSection.style.display = 'none';
        testBtn.style.display = 'none';
    }
});

async function fetchModels() {
    const provider = document.getElementById('provider');
    const apiKey = document.getElementById('api_key').value;
    const selectedOption = provider.options[provider.selectedIndex];
    const providerName = selectedOption.getAttribute('data-name');
    
    if (!apiKey) {
        alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ API Key Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
        return;
    }
    
    const modelSelect = document.getElementById('model_name');
    const modelSection = document.getElementById('modelSection');
    const modelInfo = document.getElementById('modelInfo');
    const testBtn = document.getElementById('testBtn');
    
    modelSelect.innerHTML = '<option value="">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù…Ø¯Ù„â€ŒÙ‡Ø§...</option>';
    modelSection.style.display = 'block';
    
    try {
        const response = await fetch('{% url "get_available_models" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                provider: providerName,
                api_key: apiKey
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            modelSelect.innerHTML = '<option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø¯Ù„ --</option>';
            
            data.models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = model.name || model.id;
                
                // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø¶Ø§ÙÛŒ
                if (model.context) {
                    option.textContent += ` (${model.context} tokens)`;
                }
                
                modelSelect.appendChild(option);
            });
            
            modelInfo.textContent = `${data.models.length} Ù…Ø¯Ù„ ÛŒØ§ÙØª Ø´Ø¯`;
            testBtn.style.display = 'inline-block';
        } else {
            modelSelect.innerHTML = '<option value="">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù…Ø¯Ù„â€ŒÙ‡Ø§</option>';
            modelInfo.textContent = data.error;
        }
    } catch (error) {
        modelSelect.innerHTML = '<option value="">Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø·</option>';
        modelInfo.textContent = error.toString();
    }
}

async function testConnection() {
    const provider = document.getElementById('provider').value;
    const apiKey = document.getElementById('api_key').value;
    const modelName = document.getElementById('model_name').value;
    
    if (!provider || !apiKey || !modelName) {
        alert('Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯');
        return;
    }
    
    const statusDiv = document.getElementById('connectionStatus');
    const statusText = document.getElementById('statusText');
    const usageInfo = document.getElementById('usageInfo');
    const spinner = document.getElementById('testingSpinner');
    const saveBtn = document.getElementById('saveBtn');
    
    // Show testing status
    statusDiv.className = 'alert alert-info';
    statusDiv.classList.remove('d-none');
    spinner.classList.remove('d-none');
    statusText.textContent = 'Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª Ø§ØªØµØ§Ù„...';
    usageInfo.innerHTML = '';
    
    try {
        const response = await fetch('{% url "test_api_connection" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                provider: provider,
                api_key: apiKey,
                model_name: modelName
            })
        });
        
        const data = await response.json();
        spinner.classList.add('d-none');
        
        if (data.success) {
            statusDiv.className = 'alert alert-success';
            statusText.innerHTML = 'âœ“ Ø§ØªØµØ§Ù„ Ù…ÙˆÙÙ‚!';
            
            if (data.usage) {
                usageInfo.innerHTML = `
                    <strong>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ø³Ø§Ø¨:</strong><br>
                    Ù…Ø¯Ù„: ${data.model}<br>
                    ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯: ${data.available_tokens}<br>
                    Ù…Ø­Ø¯ÙˆØ¯ÛŒØª: ${data.usage.rate_limit || 'Ù†Ø§Ù…Ø´Ø®Øµ'}
                `;
            }
            
            saveBtn.disabled = false;
        } else {
            statusDiv.className = 'alert alert-danger';
            statusText.textContent = `âœ— Ø®Ø·Ø§: ${data.error}`;
            saveBtn.disabled = true;
        }
    } catch (error) {
        spinner.classList.add('d-none');
        statusDiv.className = 'alert alert-danger';
        statusText.textContent = 'âœ— Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±';
        saveBtn.disabled = true;
    }
}

async function retestKey(keyId) {
    if (!confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† API Key Ø±Ø§ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ØªØ³Øª Ú©Ù†ÛŒØ¯ØŸ')) return;
    
    try {
        const response = await fetch('{% url "retest_api_key" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ key_id: keyId })
        });
        
        const data = await response.json();
        if (data.success) {
            alert('âœ“ Ø§ØªØµØ§Ù„ Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯!');
            location.reload();
        } else {
            alert(`âœ— Ø®Ø·Ø§: ${data.error}`);
        }
    } catch (error) {
        alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
    }
}
</script>
{% endblock %}
