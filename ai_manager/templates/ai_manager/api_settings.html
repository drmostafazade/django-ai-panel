{% extends "base.html" %}

{% block title %}ØªÙ†Ø¸ÛŒÙ…Ø§Øª API - Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª{% endblock %}

{% block extra_css %}
<style>
/* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø³ÙØ§Ø±Ø´ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
.action-btn {
    min-width: 90px;
    font-size: 0.875rem;
    font-weight: 500;
    border-radius: 0.375rem;
    transition: all 0.2s ease;
    text-align: center;
    white-space: nowrap;
    padding: 0.375rem 0.75rem;
    border: none;
    cursor: pointer;
}

.action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.action-btn i {
    margin-left: 4px;
}

/* Ø¯Ú©Ù…Ù‡ Ù…ÙˆØ¬ÙˆØ¯ÛŒ - Ø¢Ø¨ÛŒ */
.btn-balance {
    background: linear-gradient(45deg, #17a2b8, #138496);
    color: white;
}
.btn-balance:hover {
    background: linear-gradient(45deg, #138496, #117a8b);
    color: white;
}

/* Ø¯Ú©Ù…Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø´Ø®ØµÛŒ - Ø¨Ù†ÙØ´ */
.btn-personal {
    background: linear-gradient(45deg, #6f42c1, #5a32a3);
    color: white;
}
.btn-personal:hover {
    background: linear-gradient(45deg, #5a32a3, #4c2a85);
    color: white;
}

/* Ø¯Ú©Ù…Ù‡ Ù¾Ø±Ø§Ù…Ù¾Øª - Ø³Ø¨Ø² */
.btn-prompt {
    background: linear-gradient(45deg, #28a745, #218838);
    color: white;
}
.btn-prompt:hover {
    background: linear-gradient(45deg, #218838, #1e7e34);
    color: white;
}

/* Ø¯Ú©Ù…Ù‡ ØªØ³Øª - Ø¢Ø¨ÛŒ ØªÛŒØ±Ù‡ */
.btn-test {
    background: linear-gradient(45deg, #007bff, #0056b3);
    color: white;
}
.btn-test:hover {
    background: linear-gradient(45deg, #0056b3, #004085);
    color: white;
}

/* Ø¯Ú©Ù…Ù‡ ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„ - Ø²Ø±Ø¯ */
.btn-toggle {
    background: linear-gradient(45deg, #ffc107, #e0a800);
    color: #212529;
}
.btn-toggle:hover {
    background: linear-gradient(45deg, #e0a800, #d39e00);
    color: #212529;
}

/* Ø¯Ú©Ù…Ù‡ Ø­Ø°Ù - Ù‚Ø±Ù…Ø² */
.btn-delete {
    background: linear-gradient(45deg, #dc3545, #c82333);
    color: white;
}
.btn-delete:hover {
    background: linear-gradient(45deg, #c82333, #bd2130);
    color: white;
}

.table-actions {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    align-items: center;
    justify-content: flex-start;
}

.table th:last-child {
    min-width: 450px;
}

/* Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ */
.loading-spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Provider cards */
.provider-card {
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
    cursor: pointer;
}

.provider-card:hover {
    border-color: #007bff;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.provider-card.selected {
    border-color: #007bff !important;
    background-color: #f8f9ff !important;
}
</style>
{% endblock %}

{% block content %}
<h1 class="page-title mb-4">
    <i class="bi bi-key-fill text-primary"></i>
    ØªÙ†Ø¸ÛŒÙ…Ø§Øª API Keys
</h1>

{% if messages %}
<div class="mb-4">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show">
        <i class="bi bi-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- ÙØ±Ù… Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† API Key -->
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
            <i class="bi bi-plus-circle-fill"></i>
            Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† API Key Ø¬Ø¯ÛŒØ¯
        </h5>
    </div>
    <div class="card-body">
        <form method="post" action="{% url 'api_settings' %}" id="apiKeyForm">
            {% csrf_token %}
            <input type="hidden" name="model_info" id="model_info" value="{}">
            
            <!-- Progress Steps -->
            <div class="mb-4">
                <div class="d-flex justify-content-between mb-2">
                    <span class="badge bg-primary" id="step1">1. Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø±ÙˆÛŒØ³</span>
                    <span class="badge bg-secondary" id="step2">2. ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† API Key</span>
                    <span class="badge bg-secondary" id="step3">3. Ø¯Ø±ÛŒØ§ÙØª Ù…Ø¯Ù„â€ŒÙ‡Ø§</span>
                    <span class="badge bg-secondary" id="step4">4. Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø¯Ù„</span>
                    <span class="badge bg-secondary" id="step5">5. ØªØ³Øª Ùˆ Ø°Ø®ÛŒØ±Ù‡</span>
                </div>
                <div class="progress" style="height: 5px;">
                    <div class="progress-bar" id="progressBar" style="width: 20%"></div>
                </div>
            </div>
            
            <!-- Step 1: Provider Selection -->
            <div class="mb-3">
                <label class="form-label">Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø±ÙˆÛŒØ³ AI</label>
                <div class="row g-3">
                    {% for provider in providers %}
                    <div class="col-md-6">
                        <div class="form-check card p-3 provider-card">
                            <input class="form-check-input" type="radio" name="provider" 
                                   value="{{ provider.id }}" data-name="{{ provider.name }}"
                                   id="provider_{{ provider.id }}" onchange="selectProvider(this)">
                            <label class="form-check-label w-100" for="provider_{{ provider.id }}">
                                <strong>{{ provider.get_name_display }}</strong>
                                <br>
                                <small class="text-muted">
                                    {% if provider.name == 'claude' %}
                                    Ø¢Ø®Ø±ÛŒÙ† Ù…Ø¯Ù„â€ŒÙ‡Ø§: Claude 3.5, 3.7, Opus 4, Sonnet 4
                                    {% elif provider.name == 'openai' %}
                                    GPT-4o, GPT-4 Turbo, GPT-3.5
                                    {% elif provider.name == 'gemini' %}
                                    Gemini Pro, Gemini 1.5
                                    {% endif %}
                                </small>
                            </label>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Step 2: API Key Input -->
            <div class="mb-3" id="apiKeySection" style="display: none;">
                <label class="form-label">API Key</label>
                <div class="input-group">
                    <span class="input-group-text">ğŸ”</span>
                    <input type="password" name="api_key" id="api_key" class="form-control" 
                           placeholder="sk-..." required>
                    <button type="button" class="btn btn-outline-secondary" onclick="toggleKeyVisibility()">
                        <i class="bi bi-eye" id="keyVisibilityIcon"></i>
                    </button>
                    <button type="button" class="btn btn-primary" onclick="fetchModels()" id="fetchModelsBtn">
                        <i class="bi bi-cloud-download"></i> Ø¯Ø±ÛŒØ§ÙØª Ù…Ø¯Ù„â€ŒÙ‡Ø§
                    </button>
                </div>
                <small class="text-muted">API Key Ø´Ù…Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø§Ù…Ù† Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯</small>
            </div>
            
            <!-- Step 3: Loading Models -->
            <div class="mb-3" id="loadingSection" style="display: none;">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary mb-3"></div>
                    <p>Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯...</p>
                </div>
            </div>
            
            <!-- Step 4: Model Selection -->
            <div class="mb-3" id="modelSection" style="display: none;">
                <label class="form-label">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø¯Ù„</label>
                <div id="modelsList" class="row g-3">
                    <!-- Ù…Ø¯Ù„â€ŒÙ‡Ø§ Ø¨Ù‡ ØµÙˆØ±Øª dynamic Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                </div>
            </div>
            
            <!-- Connection Status -->
            <div id="connectionStatus" class="alert d-none mb-3">
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm me-2 d-none" id="testingSpinner"></div>
                    <span id="statusText"></span>
                </div>
                <div id="statusDetails" class="mt-2 small"></div>
            </div>
            
            <!-- Action Buttons -->
            <div class="d-flex gap-2" id="actionButtons" style="display: none;">
                <button type="button" class="btn btn-test action-btn" onclick="testConnection()" id="testBtn">
                    <i class="bi bi-plug"></i> ØªØ³Øª Ø§ØªØµØ§Ù„
                </button>
                <button type="submit" class="btn btn-success action-btn" id="saveBtn" disabled>
                    <i class="bi bi-save"></i> Ø°Ø®ÛŒØ±Ù‡ API Key
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Ù„ÛŒØ³Øª API Keys -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0">ğŸ“‹ API Keys Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡</h5>
    </div>
    <div class="card-body">
        {% if user_keys %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Ø³Ø±ÙˆÛŒØ³</th>
                        <th>Ù…Ø¯Ù„</th>
                        <th>ÙˆØ¶Ø¹ÛŒØª</th>
                        <th>Ù…ÙˆØ¬ÙˆØ¯ÛŒ</th>
                        <th>ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ Ù…ØµØ±ÙÛŒ</th>
                        <th>Ø¢Ø®Ø±ÛŒÙ† Ø§Ø³ØªÙØ§Ø¯Ù‡</th>
                        <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key in user_keys %}
                    <tr>
                        <td>
                            <i class="bi bi-robot"></i>
                            {{ key.provider.get_name_display }}
                        </td>
                        <td>
                            <code class="small">{{ key.model_name|default:"-" }}</code>
                        </td>
                        <td>
                            {% if key.is_active %}
                                {% if key.is_verified %}
                                <span class="badge bg-success">âœ“ ÙØ¹Ø§Ù„</span>
                                {% else %}
                                <span class="badge bg-warning">âš  ØªØ³Øª Ù†Ø´Ø¯Ù‡</span>
                                {% endif %}
                            {% else %}
                            <span class="badge bg-secondary">ØºÛŒØ±ÙØ¹Ø§Ù„</span>
                            {% endif %}
                        </td>
                        <td>
                            <button onclick="showBalance({{ key.id }})" 
                                    class="btn btn-balance action-btn btn-sm" 
                                    id="balance-{{ key.id }}"
                                    title="Ø¨Ø±Ø±Ø³ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ">
                                <i class="bi bi-wallet2"></i>
                                Ù…ÙˆØ¬ÙˆØ¯ÛŒ
                            </button>
                        </td>
                        <td>
                            <small>{{ key.used_tokens|floatformat:0 }} ØªÙˆÚ©Ù†</small>
                        </td>
                        <td>
                            <small>{{ key.last_used|date:"Y/m/d H:i"|default:"Ù‡Ø±Ú¯Ø²" }}</small>
                        </td>
                        <td>
                            <div class="table-actions">
                                <a href="{% url 'personal_settings' key.id %}" 
                                   class="btn btn-personal action-btn btn-sm" 
                                   title="ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø´Ø®ØµÛŒ">
                                    <i class="bi bi-person-gear"></i>
                                    Ø´Ø®ØµÛŒ
                                </a>
                                
                                <button onclick="openPromptModal({{ key.id }})" 
                                        class="btn btn-prompt action-btn btn-sm" 
                                        title="Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ø±Ø§Ù…Ù¾Øª">
                                    <i class="bi bi-plus-circle"></i>
                                    Ù¾Ø±Ø§Ù…Ù¾Øª
                                </button>
                                
                                <button onclick="retestKey({{ key.id }})" 
                                        class="btn btn-test action-btn btn-sm" 
                                        title="ØªØ³Øª Ù…Ø¬Ø¯Ø¯">
                                    <i class="bi bi-arrow-clockwise"></i>
                                    ØªØ³Øª
                                </button>
                                
                                <form method="post" action="{% url 'toggle_api_key' %}" style="display: inline;">
                                    {% csrf_token %}
                                    <input type="hidden" name="key_id" value="{{ key.id }}">
                                    <button type="submit" 
                                            class="btn btn-toggle action-btn btn-sm" 
                                            title="ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª">
                                        <i class="bi bi-toggle-{% if key.is_active %}on{% else %}off{% endif %}"></i>
                                        {% if key.is_active %}ÙØ¹Ø§Ù„{% else %}ØºÛŒØ±ÙØ¹Ø§Ù„{% endif %}
                                    </button>
                                </form>
                                
                                <form method="post" action="{% url 'delete_api_key' %}" 
                                      style="display: inline;" 
                                      onsubmit="return confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† API Key Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ');">
                                    {% csrf_token %}
                                    <input type="hidden" name="key_id" value="{{ key.id }}">
                                    <button type="submit" 
                                            class="btn btn-delete action-btn btn-sm" 
                                            title="Ø­Ø°Ù">
                                        <i class="bi bi-trash"></i>
                                        Ø­Ø°Ù
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-key" style="font-size: 3rem; color: #ddd;"></i>
            <p class="text-muted mt-3">Ù‡Ù†ÙˆØ² API Key Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Ø¢Ù…Ø§Ø± Ù…ØµØ±Ù Ùˆ Ø±Ø§Ù‡Ù†Ù…Ø§ -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0">ğŸ“Š Ø¢Ù…Ø§Ø± Ù…ØµØ±Ù Ø§ÛŒÙ† Ù…Ø§Ù‡</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-primary">{{ total_tokens_month|default:"0"|floatformat:0 }}</h4>
                        <small class="text-muted">ØªÙˆÚ©Ù† Ù…ØµØ±ÙÛŒ</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success">${{ total_cost_month|default:"0"|floatformat:2 }}</h4>
                        <small class="text-muted">Ù‡Ø²ÛŒÙ†Ù‡ ØªÙ‚Ø±ÛŒØ¨ÛŒ</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">ğŸš€ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø³Ø±ÛŒØ¹</h6>
            </div>
            <div class="card-body small">
                <h6>Ø¯Ø±ÛŒØ§ÙØª API Key:</h6>
                <ul class="ps-3">
                    <li><strong>Claude:</strong> <a href="https://console.anthropic.com/api" target="_blank">console.anthropic.com</a></li>
                    <li><strong>OpenAI:</strong> <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a></li>
                    <li><strong>Gemini:</strong> <a href="https://makersuite.google.com/app/apikey" target="_blank">makersuite.google.com</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ø±Ø§Ù…Ù¾Øª Ø³Ø±ÛŒØ¹ -->
<div class="modal fade" id="promptModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ø±Ø§Ù…Ù¾Øª Ø³Ø±ÛŒØ¹</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="quickPromptForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Ø¹Ù†ÙˆØ§Ù†</label>
                        <input type="text" class="form-control" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ù…ØªÙ† Ù¾Ø±Ø§Ù…Ù¾Øª</label>
                        <textarea class="form-control" name="content" rows="4" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø§Ù†ØµØ±Ø§Ù</button>
                    <button type="submit" class="btn btn-success">Ø§ÙØ²ÙˆØ¯Ù†</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ global
let selectedModel = null;
let currentStep = 1;
let modelsData = [];
let currentKeyId = null;

function updateProgress(step) {
    currentStep = step;
    const progress = step * 20;
    document.getElementById('progressBar').style.width = progress + '%';
    
    for (let i = 1; i <= 5; i++) {
        const badge = document.getElementById(`step${i}`);
        if (i <= step) {
            badge.classList.remove('bg-secondary');
            badge.classList.add('bg-primary');
        } else {
            badge.classList.remove('bg-primary');
            badge.classList.add('bg-secondary');
        }
    }
}

function selectProvider(radio) {
    // Ø­Ø°Ù selection Ù‚Ø¨Ù„ÛŒ
    document.querySelectorAll('.provider-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    if (radio.checked) {
        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† highlight
        radio.closest('.provider-card').classList.add('selected');
        
        document.getElementById('apiKeySection').style.display = 'block';
        updateProgress(2);
    }
}

function toggleKeyVisibility() {
    const input = document.getElementById('api_key');
    const icon = document.getElementById('keyVisibilityIcon');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('bi-eye');
        icon.classList.add('bi-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('bi-eye-slash');
        icon.classList.add('bi-eye');
    }
}

async function fetchModels() {
    const provider = document.querySelector('input[name="provider"]:checked');
    const apiKey = document.getElementById('api_key').value;
    
    if (!provider || !apiKey) {
        alert('Ù„Ø·ÙØ§Ù‹ Ø³Ø±ÙˆÛŒØ³ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯Ù‡ Ùˆ API Key Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
        return;
    }
    
    const providerName = provider.getAttribute('data-name');
    
    document.getElementById('loadingSection').style.display = 'block';
    document.getElementById('modelSection').style.display = 'none';
    updateProgress(3);
    
    try {
        const response = await fetch('{% url "get_available_models" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                provider: providerName,
                api_key: apiKey
            })
        });
        
        const data = await response.json();
        
        document.getElementById('loadingSection').style.display = 'none';
        
        if (data.success) {
            modelsData = data.models;
            displayModels(data.models);
            updateProgress(4);
        } else {
            alert(`Ø®Ø·Ø§: ${data.error}`);
            updateProgress(2);
        }
    } catch (error) {
        document.getElementById('loadingSection').style.display = 'none';
        alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±: ' + error);
        updateProgress(2);
    }
}

function displayModels(models) {
    const modelsList = document.getElementById('modelsList');
    const modelSection = document.getElementById('modelSection');
    
    modelsList.innerHTML = '';
    
    models.forEach((model, index) => {
        const available = model.available !== false;
        
        const card = document.createElement('div');
        card.className = 'col-md-6';
        card.innerHTML = `
            <div class="card ${available ? '' : 'opacity-50'}" style="cursor: ${available ? 'pointer' : 'not-allowed'};">
                <div class="card-body">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="model_name" 
                               value="${model.id}" id="model_${index}"
                               ${available ? '' : 'disabled'}
                               onchange="selectModel('${model.id}', ${index})">
                        <label class="form-check-label w-100" for="model_${index}">
                            <strong>${model.name || model.id}</strong>
                            ${model.description ? `<br><small class="text-muted">${model.description}</small>` : ''}
                            <div class="mt-2">
                                ${model.context_window ? `<span class="badge bg-secondary">Context: ${model.context_window.toLocaleString()}</span>` : ''}
                                ${model.features ? model.features.map(f => `<span class="badge bg-info ms-1">${f}</span>`).join('') : ''}
                                ${!available ? '<span class="badge bg-danger ms-1">ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¯Ø³ØªØ±Ø³</span>' : ''}
                            </div>
                        </label>
                    </div>
                </div>
            </div>
        `;
        modelsList.appendChild(card);
    });
    
    modelSection.style.display = 'block';
    document.getElementById('actionButtons').style.display = 'flex';
}

function selectModel(modelId, index) {
    selectedModel = modelsData[index];
    document.getElementById('model_info').value = JSON.stringify(selectedModel);
    updateProgress(5);
}

async function testConnection() {
    const provider = document.querySelector('input[name="provider"]:checked')?.value;
    const apiKey = document.getElementById('api_key').value;
    const modelName = document.querySelector('input[name="model_name"]:checked')?.value;
    
    if (!provider || !apiKey || !modelName) {
        alert('Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ Ù…Ø±Ø§Ø­Ù„ Ø±Ø§ ØªÚ©Ù…ÛŒÙ„ Ú©Ù†ÛŒØ¯');
        return;
    }
    
    const statusDiv = document.getElementById('connectionStatus');
    const statusText = document.getElementById('statusText');
    const statusDetails = document.getElementById('statusDetails');
    const spinner = document.getElementById('testingSpinner');
    const saveBtn = document.getElementById('saveBtn');
    
    statusDiv.className = 'alert alert-info';
    statusDiv.classList.remove('d-none');
    spinner.classList.remove('d-none');
    statusText.textContent = 'Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª Ø§ØªØµØ§Ù„...';
    statusDetails.innerHTML = '';
    
    try {
        const response = await fetch('{% url "test_api_connection" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                provider: provider,
                api_key: apiKey,
                model_name: modelName
            })
        });
        
        const data = await response.json();
        spinner.classList.add('d-none');
        
        if (data.success) {
            statusDiv.className = 'alert alert-success';
            statusText.innerHTML = 'âœ“ Ø§ØªØµØ§Ù„ Ù…ÙˆÙÙ‚!';
            saveBtn.disabled = false;
        } else {
            statusDiv.className = 'alert alert-danger';
            statusText.textContent = `âœ— Ø®Ø·Ø§: ${data.error}`;
            saveBtn.disabled = true;
        }
    } catch (error) {
        spinner.classList.add('d-none');
        statusDiv.className = 'alert alert-danger';
        statusText.textContent = 'âœ— Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±: ' + error;
        saveBtn.disabled = true;
    }
}

async function showBalance(keyId) {
    const button = document.getElementById(`balance-${keyId}`);
    const originalHtml = button.innerHTML;
    
    button.innerHTML = '<i class="bi bi-arrow-clockwise loading-spin"></i> Ø¨Ø±Ø±Ø³ÛŒ...';
    button.disabled = true;
    
    try {
        const response = await fetch(`/ai-chat/balance/${keyId}/`);
        const data = await response.json();
        
        if (data.success) {
            if (data.balance_type === 'unlimited') {
                button.innerHTML = '<i class="bi bi-infinity"></i> Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯';
                button.className = 'btn btn-success action-btn btn-sm';
            } else if (data.balance_type === 'active') {
                button.innerHTML = '<i class="bi bi-check-circle"></i> ÙØ¹Ø§Ù„';
                button.className = 'btn btn-success action-btn btn-sm';
            } else {
                button.innerHTML = '<i class="bi bi-question-circle"></i> Ù†Ø§Ù…Ø´Ø®Øµ';
                button.className = 'btn btn-info action-btn btn-sm';
            }
        } else {
            button.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Ø®Ø·Ø§';
            button.className = 'btn btn-danger action-btn btn-sm';
        }
    } catch (error) {
        button.innerHTML = '<i class="bi bi-x-circle"></i> Ø®Ø·Ø§';
        button.className = 'btn btn-danger action-btn btn-sm';
    } finally {
        button.disabled = false;
        
        setTimeout(() => {
            button.innerHTML = originalHtml;
            button.className = 'btn btn-balance action-btn btn-sm';
        }, 3000);
    }
}

function openPromptModal(keyId) {
    currentKeyId = keyId;
    const modal = new bootstrap.Modal(document.getElementById('promptModal'));
    modal.show();
}

document.getElementById('quickPromptForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
    
    try {
        const response = await fetch(`/ai-chat/add-prompt/${currentKeyId}/`, {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('promptModal')).hide();
            showToast('success', 'Ù¾Ø±Ø§Ù…Ù¾Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
            e.target.reset();
        }
    } catch (error) {
        showToast('danger', 'Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ø±Ø§Ù…Ù¾Øª');
    }
});

async function retestKey(keyId) {
    if (!confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† API Key Ø±Ø§ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ØªØ³Øª Ú©Ù†ÛŒØ¯ØŸ')) return;
    
    try {
        const response = await fetch('{% url "retest_api_key" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ key_id: keyId })
        });
        
        const data = await response.json();
        if (data.success) {
            showToast('success', 'âœ“ Ø§ØªØµØ§Ù„ Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯!');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('danger', `âœ— Ø®Ø·Ø§: ${data.error}`);
        }
    } catch (error) {
        showToast('danger', 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
    }
}

function showToast(type, message) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentElement) toast.remove();
    }, 4000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
