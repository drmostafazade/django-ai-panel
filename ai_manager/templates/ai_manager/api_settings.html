{% extends "base.html" %}

{% block title %}ØªÙ†Ø¸ÛŒÙ…Ø§Øª API - Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª{% endblock %}

{% block content %}
<h1 class="page-title mb-4">ØªÙ†Ø¸ÛŒÙ…Ø§Øª API Keys</h1>

<!-- Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ -->
{% if messages %}
<div class="mb-4">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="row">
    <div class="col-md-8">
        <!-- ÙØ±Ù… Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† API Key -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">ğŸ”‘ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† API Key Ø¬Ø¯ÛŒØ¯</h5>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'api_settings' %}" id="apiKeyForm">
                    {% csrf_token %}
                    <input type="hidden" name="model_info" id="model_info" value="{}">
                    
                    <!-- Progress Steps -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="badge bg-primary" id="step1">1. Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø±ÙˆÛŒØ³</span>
                            <span class="badge bg-secondary" id="step2">2. ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† API Key</span>
                            <span class="badge bg-secondary" id="step3">3. Ø¯Ø±ÛŒØ§ÙØª Ù…Ø¯Ù„â€ŒÙ‡Ø§</span>
                            <span class="badge bg-secondary" id="step4">4. Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø¯Ù„</span>
                            <span class="badge bg-secondary" id="step5">5. ØªØ³Øª Ùˆ Ø°Ø®ÛŒØ±Ù‡</span>
                        </div>
                        <div class="progress" style="height: 5px;">
                            <div class="progress-bar" id="progressBar" style="width: 20%"></div>
                        </div>
                    </div>
                    
                    <!-- Step 1: Provider Selection -->
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø±ÙˆÛŒØ³ AI</label>
                        <div class="row g-3">
                            {% for provider in providers %}
                            <div class="col-md-6">
                                <div class="form-check card p-3">
                                    <input class="form-check-input" type="radio" name="provider" 
                                           value="{{ provider.id }}" data-name="{{ provider.name }}"
                                           id="provider_{{ provider.id }}" onchange="selectProvider(this)">
                                    <label class="form-check-label w-100" for="provider_{{ provider.id }}">
                                        <strong>{{ provider.get_name_display }}</strong>
                                        <br>
                                        <small class="text-muted">
                                            {% if provider.name == 'claude' %}
                                            Ø¢Ø®Ø±ÛŒÙ† Ù…Ø¯Ù„â€ŒÙ‡Ø§: Claude 3.5, 3.7, Opus 4, Sonnet 4
                                            {% elif provider.name == 'openai' %}
                                            GPT-4o, GPT-4 Turbo, GPT-3.5
                                            {% elif provider.name == 'gemini' %}
                                            Gemini Pro, Gemini 1.5
                                            {% endif %}
                                        </small>
                                    </label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Step 2: API Key Input -->
                    <div class="mb-3" id="apiKeySection" style="display: none;">
                        <label class="form-label">API Key</label>
                        <div class="input-group">
                            <span class="input-group-text">ğŸ”</span>
                            <input type="password" name="api_key" id="api_key" class="form-control" 
                                   placeholder="sk-..." required>
                            <button type="button" class="btn btn-outline-secondary" onclick="toggleKeyVisibility()">
                                <i class="bi bi-eye" id="keyVisibilityIcon"></i>
                            </button>
                            <button type="button" class="btn btn-primary" onclick="fetchModels()">
                                <i class="bi bi-cloud-download"></i> Ø¯Ø±ÛŒØ§ÙØª Ù…Ø¯Ù„â€ŒÙ‡Ø§
                            </button>
                        </div>
                        <small class="text-muted">API Key Ø´Ù…Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø§Ù…Ù† Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯</small>
                    </div>
                    
                    <!-- Step 3: Loading Models -->
                    <div class="mb-3" id="loadingSection" style="display: none;">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary mb-3"></div>
                            <p>Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯...</p>
                        </div>
                    </div>
                    
                    <!-- Step 4: Model Selection -->
                    <div class="mb-3" id="modelSection" style="display: none;">
                        <label class="form-label">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø¯Ù„</label>
                        <div id="modelsList" class="row g-3">
                            <!-- Ù…Ø¯Ù„â€ŒÙ‡Ø§ Ø¨Ù‡ ØµÙˆØ±Øª dynamic Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                        </div>
                    </div>
                    
                    <!-- Connection Status -->
                    <div id="connectionStatus" class="alert d-none mb-3">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2 d-none" id="testingSpinner"></div>
                            <span id="statusText"></span>
                        </div>
                        <div id="statusDetails" class="mt-2 small"></div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="d-flex gap-2" id="actionButtons" style="display: none;">
                        <button type="button" class="btn btn-secondary" onclick="testConnection()">
                            <i class="bi bi-plug"></i> ØªØ³Øª Ø§ØªØµØ§Ù„
                        </button>
                        <button type="submit" class="btn btn-success" id="saveBtn" disabled>
                            <i class="bi bi-save"></i> Ø°Ø®ÛŒØ±Ù‡ API Key
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Ù„ÛŒØ³Øª API Keys -->
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0">ğŸ“‹ API Keys Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡</h5>
            </div>
            <div class="card-body">
                {% if user_keys %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Ø³Ø±ÙˆÛŒØ³</th>
                                <th>Ù…Ø¯Ù„</th>
                                <th>ÙˆØ¶Ø¹ÛŒØª</th>
                                <th>ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ Ù…ØµØ±ÙÛŒ</th>
                                <th>Ø¢Ø®Ø±ÛŒÙ† Ø§Ø³ØªÙØ§Ø¯Ù‡</th>
                                <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for key in user_keys %}
                            <tr>
                                <td>
                                    <i class="bi bi-robot"></i>
                                    {{ key.provider.get_name_display }}
                                </td>
                                <td>
                                    <code class="small">{{ key.model_name|default:"-" }}</code>
                                    {% if key.model_info.features %}
                                    <br>
                                    {% for feature in key.model_info.features %}
                                    <span class="badge bg-info">{{ feature }}</span>
                                    {% endfor %}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if key.is_active %}
                                        {% if key.is_verified %}
                                        <span class="badge bg-success">âœ“ ÙØ¹Ø§Ù„ Ùˆ ØªØ³Øª Ø´Ø¯Ù‡</span>
                                        {% else %}
                                        <span class="badge bg-warning">âš  ØªØ³Øª Ù†Ø´Ø¯Ù‡</span>
                                        {% endif %}
                                    {% else %}
                                    <span class="badge bg-secondary">ØºÛŒØ±ÙØ¹Ø§Ù„</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small>
                                        {{ key.used_tokens|floatformat:0 }} ØªÙˆÚ©Ù†
                                        {% if key.model_info.pricing %}
                                        <br>
                                        <span class="text-muted">
                                            ~${{ key.used_tokens|floatformat:0 }}
                                        </span>
                                        {% endif %}
                                    </small>
                                </td>
                                <td>
                                    <small>{{ key.last_used|date:"Y/m/d H:i"|default:"Ù‡Ø±Ú¯Ø²" }}</small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button onclick="showKeyDetails({{ key.id }})" 
                                                class="btn btn-outline-info" title="Ø¬Ø²Ø¦ÛŒØ§Øª">
                                            <i class="bi bi-info-circle"></i>
                                        </button>
                                        <button onclick="retestKey({{ key.id }})" 
                                                class="btn btn-outline-primary" title="ØªØ³Øª Ù…Ø¬Ø¯Ø¯">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                        <form method="post" action="{% url 'toggle_api_key' %}" style="display: inline;">
                                            {% csrf_token %}
                                            <input type="hidden" name="key_id" value="{{ key.id }}">
                                            <button type="submit" class="btn btn-outline-warning" 
                                                    title="{% if key.is_active %}ØºÛŒØ±ÙØ¹Ø§Ù„{% else %}ÙØ¹Ø§Ù„{% endif %}">
                                                <i class="bi bi-toggle-{% if key.is_active %}on{% else %}off{% endif %}"></i>
                                            </button>
                                        </form>
                                        <form method="post" action="{% url 'delete_api_key' %}" 
                                              style="display: inline;" 
                                              onsubmit="return confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† API Key Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ');">
                                            {% csrf_token %}
                                            <input type="hidden" name="key_id" value="{{ key.id }}">
                                            <button type="submit" class="btn btn-outline-danger" title="Ø­Ø°Ù">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-key" style="font-size: 3rem; color: #ddd;"></i>
                    <p class="text-muted mt-3">Ù‡Ù†ÙˆØ² API Key Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯</p>
                    <p class="text-muted">Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ Ø§Ø² ÙØ±Ù… Ø¨Ø§Ù„Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Ø¢Ù…Ø§Ø± Ù…ØµØ±Ù -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0">ğŸ“Š Ø¢Ù…Ø§Ø± Ù…ØµØ±Ù Ø§ÛŒÙ† Ù…Ø§Ù‡</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-primary">{{ total_tokens_month|default:"0"|floatformat:0 }}</h4>
                        <small class="text-muted">ØªÙˆÚ©Ù† Ù…ØµØ±ÙÛŒ</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success">${{ total_cost_month|default:"0"|floatformat:2 }}</h4>
                        <small class="text-muted">Ù‡Ø²ÛŒÙ†Ù‡ ØªÙ‚Ø±ÛŒØ¨ÛŒ</small>
                    </div>
                </div>
                
                <hr>
                
                <h6 class="mb-2">ØªÙˆØ²ÛŒØ¹ Ù…ØµØ±Ù:</h6>
                <div id="usageChart" style="height: 150px;">
                    <!-- Ù†Ù…ÙˆØ¯Ø§Ø± Ù…ØµØ±Ù -->
                </div>
            </div>
        </div>
        
        <!-- Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø³Ø±ÛŒØ¹ -->
        <div class="card mb-3">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">ğŸš€ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø³Ø±ÛŒØ¹</h6>
            </div>
            <div class="card-body small">
                <h6>Ø¯Ø±ÛŒØ§ÙØª API Key:</h6>
                <ul class="ps-3">
                    <li>
                        <strong>Claude:</strong>
                        <a href="https://console.anthropic.com/api" target="_blank">
                            console.anthropic.com <i class="bi bi-box-arrow-up-right"></i>
                        </a>
                    </li>
                    <li>
                        <strong>OpenAI:</strong>
                        <a href="https://platform.openai.com/api-keys" target="_blank">
                            platform.openai.com <i class="bi bi-box-arrow-up-right"></i>
                        </a>
                    </li>
                    <li>
                        <strong>Google:</strong>
                        <a href="https://makersuite.google.com/app/apikey" target="_blank">
                            makersuite.google.com <i class="bi bi-box-arrow-up-right"></i>
                        </a>
                    </li>
                </ul>
                
                <div class="alert alert-warning py-2 mt-3">
                    <strong>âš ï¸ Ù†Ú©Ø§Øª Ø§Ù…Ù†ÛŒØªÛŒ:</strong>
                    <ul class="mb-0 ps-3">
                        <li>API Key Ø±Ø§ Ù…Ø­Ø±Ù…Ø§Ù†Ù‡ Ù†Ú¯Ù‡ Ø¯Ø§Ø±ÛŒØ¯</li>
                        <li>Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù¾Ø±ÙˆÚ˜Ù‡ Key Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ø¨Ø³Ø§Ø²ÛŒØ¯</li>
                        <li>Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§ÛŒ usage Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ -->
        <div class="card">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0">âœ¨ ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯</h6>
            </div>
            <div class="card-body small">
                <ul class="ps-3 mb-0">
                    <li>Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ø¢Ø®Ø±ÛŒÙ† Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Claude 3.5, 3.7, Opus 4</li>
                    <li>Ø¯Ø±ÛŒØ§ÙØª Ø®ÙˆØ¯Ú©Ø§Ø± Ù„ÛŒØ³Øª Ù…Ø¯Ù„â€ŒÙ‡Ø§</li>
                    <li>Ù†Ù…Ø§ÛŒØ´ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ Ù…ØµØ±ÙÛŒ</li>
                    <li>Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‡Ø²ÛŒÙ†Ù‡ ØªÙ‚Ø±ÛŒØ¨ÛŒ</li>
                    <li>ØªØ³Øª Ø§ØªØµØ§Ù„ Ù¾ÛŒØ´Ø±ÙØªÙ‡</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Key Details -->
<div class="modal fade" id="keyDetailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ø¬Ø²Ø¦ÛŒØ§Øª API Key</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="keyDetailsContent">
                <!-- Ù…Ø­ØªÙˆØ§ Ø¨Ù‡ ØµÙˆØ±Øª dynamic -->
            </div>
        </div>
    </div>
</div>

<script>
let selectedModel = null;
let currentStep = 1;

function updateProgress(step) {
    currentStep = step;
    const progress = step * 20;
    document.getElementById('progressBar').style.width = progress + '%';
    
    // Update step badges
    for (let i = 1; i <= 5; i++) {
        const badge = document.getElementById(`step${i}`);
        if (i <= step) {
            badge.classList.remove('bg-secondary');
            badge.classList.add('bg-primary');
        } else {
            badge.classList.remove('bg-primary');
            badge.classList.add('bg-secondary');
        }
    }
}

function selectProvider(radio) {
    if (radio.checked) {
        document.getElementById('apiKeySection').style.display = 'block';
        updateProgress(2);
    }
}

function toggleKeyVisibility() {
    const input = document.getElementById('api_key');
    const icon = document.getElementById('keyVisibilityIcon');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('bi-eye');
        icon.classList.add('bi-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('bi-eye-slash');
        icon.classList.add('bi-eye');
    }
}

async function fetchModels() {
    const provider = document.querySelector('input[name="provider"]:checked');
    const apiKey = document.getElementById('api_key').value;
    
    if (!provider || !apiKey) {
        alert('Ù„Ø·ÙØ§Ù‹ Ø³Ø±ÙˆÛŒØ³ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯Ù‡ Ùˆ API Key Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
        return;
    }
    
    const providerName = provider.getAttribute('data-name');
    
    // Show loading
    document.getElementById('loadingSection').style.display = 'block';
    document.getElementById('modelSection').style.display = 'none';
    updateProgress(3);
    
    try {
        const response = await fetch('{% url "get_available_models" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                provider: providerName,
                api_key: apiKey
            })
        });
        
        const data = await response.json();
        
        document.getElementById('loadingSection').style.display = 'none';
        
        if (data.success) {
            displayModels(data.models);
            updateProgress(4);
            
            // Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ø³Ø§Ø¨
            if (data.account_info) {
                showAccountInfo(data.account_info);
            }
        } else {
            alert(`Ø®Ø·Ø§: ${data.error}`);
        }
    } catch (error) {
        document.getElementById('loadingSection').style.display = 'none';
        alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
    }
}

function displayModels(models) {
    const modelsList = document.getElementById('modelsList');
    const modelSection = document.getElementById('modelSection');
    
    modelsList.innerHTML = '';
    
    models.forEach((model, index) => {
        const available = model.available !== false;
        const card = document.createElement('div');
        card.className = 'col-md-6';
        card.innerHTML = `
            <div class="card ${available ? '' : 'opacity-50'}" style="cursor: ${available ? 'pointer' : 'not-allowed'};">
                <div class="card-body">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="model_name" 
                               value="${model.id}" id="model_${index}"
                               ${available ? '' : 'disabled'}
                               onchange="selectModel('${model.id}', ${JSON.stringify(model).replace(/"/g, '&quot;')})">
                        <label class="form-check-label w-100" for="model_${index}">
                            <strong>${model.name || model.id}</strong>
                            ${model.description ? `<br><small class="text-muted">${model.description}</small>` : ''}
                            <div class="mt-2">
                                ${model.context_window ? `<span class="badge bg-secondary">Context: ${model.context_window.toLocaleString()}</span>` : ''}
                                ${model.features ? model.features.map(f => `<span class="badge bg-info ms-1">${f}</span>`).join('') : ''}
                                ${!available ? '<span class="badge bg-danger ms-1">ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¯Ø³ØªØ±Ø³</span>' : ''}
                            </div>
                            ${model.pricing ? `
                            <div class="mt-1">
                                <small class="text-muted">
                                    Input: $${model.pricing.input}/1M | Output: $${model.pricing.output}/1M
                                </small>
                            </div>
                            ` : ''}
                        </label>
                    </div>
                </div>
            </div>
        `;
        modelsList.appendChild(card);
    });
    
    modelSection.style.display = 'block';
    document.getElementById('actionButtons').style.display = 'flex';
}

function selectModel(modelId, modelInfo) {
    selectedModel = JSON.parse(decodeURIComponent(modelInfo));
    document.getElementById("model_info").value = JSON.stringify(selectedModel);
    updateProgress(5);
}

function showAccountInfo(accountInfo) {
    let info = '<div class="alert alert-info mb-3"><strong>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ø³Ø§Ø¨:</strong><br>';
    
    if (accountInfo.organization) {
        info += `Ø³Ø§Ø²Ù…Ø§Ù†: ${accountInfo.organization}<br>`;
    }
    
    if (accountInfo.usage_info) {
        if (accountInfo.usage_info.subscription) {
            const sub = accountInfo.usage_info.subscription;
            info += `Ø·Ø±Ø­: ${sub.plan?.title || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>`;
            info += `Ù…Ø­Ø¯ÙˆØ¯ÛŒØª: $${sub.hard_limit_usd || 0}<br>`;
        }
        
        if (accountInfo.usage_info.usage) {
            const usage = accountInfo.usage_info.usage;
            info += `Ù…ØµØ±Ù Ø§ÛŒÙ† Ù…Ø§Ù‡: $${usage.total_usage?.toFixed(2) || 0}<br>`;
        }
    }
    
    info += '</div>';
    
    // Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ø¨Ø®Ø´ ÙˆØ¶Ø¹ÛŒØª
    const statusDiv = document.getElementById('connectionStatus');
    statusDiv.innerHTML = info;
    statusDiv.classList.remove('d-none');
}

async function testConnection() {
    const provider = document.querySelector('input[name="provider"]:checked')?.value;
    const apiKey = document.getElementById('api_key').value;
    const modelName = document.querySelector('input[name="model_name"]:checked')?.value;
    
    if (!provider || !apiKey || !modelName) {
        alert('Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ Ù…Ø±Ø§Ø­Ù„ Ø±Ø§ ØªÚ©Ù…ÛŒÙ„ Ú©Ù†ÛŒØ¯');
        return;
    }
    
    const statusDiv = document.getElementById('connectionStatus');
    const statusText = document.getElementById('statusText');
    const statusDetails = document.getElementById('statusDetails');
    const spinner = document.getElementById('testingSpinner');
    const saveBtn = document.getElementById('saveBtn');
    
    // Show testing status
    statusDiv.className = 'alert alert-info';
    statusDiv.classList.remove('d-none');
    spinner.classList.remove('d-none');
    statusText.textContent = 'Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª Ø§ØªØµØ§Ù„...';
    statusDetails.innerHTML = '';
    
    try {
        const response = await fetch('{% url "test_api_connection" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                provider: provider,
                api_key: apiKey,
                model_name: modelName
            })
        });
        
        const data = await response.json();
        spinner.classList.add('d-none');
        
        if (data.success) {
            statusDiv.className = 'alert alert-success';
            statusText.innerHTML = 'âœ“ Ø§ØªØµØ§Ù„ Ù…ÙˆÙÙ‚!';
            
            let details = '<strong>Ø¬Ø²Ø¦ÛŒØ§Øª:</strong><br>';
            details += `Ù…Ø¯Ù„: ${data.model}<br>`;
            
            if (data.usage) {
                details += `ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ ØªØ³Øª: ${data.usage.total_tokens}<br>`;
                if (data.usage.estimated_cost) {
                    details += `Ù‡Ø²ÛŒÙ†Ù‡ ØªØ³Øª: ${data.usage.estimated_cost}<br>`;
                }
            }
            
            if (data.limits) {
                details += `Context Window: ${data.limits.context_window?.toLocaleString() || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>`;
            }
            
            if (data.features && data.features.length > 0) {
                details += `ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§: ${data.features.join(', ')}<br>`;
            }
            
            statusDetails.innerHTML = details;
            saveBtn.disabled = false;
        } else {
            statusDiv.className = 'alert alert-danger';
            statusText.textContent = `âœ— Ø®Ø·Ø§: ${data.error}`;
            saveBtn.disabled = true;
        }
    } catch (error) {
        spinner.classList.add('d-none');
        statusDiv.className = 'alert alert-danger';
        statusText.textContent = 'âœ— Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±';
        saveBtn.disabled = true;
    }
}

async function retestKey(keyId) {
    if (!confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† API Key Ø±Ø§ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ØªØ³Øª Ú©Ù†ÛŒØ¯ØŸ')) return;
    
    try {
        const response = await fetch('{% url "retest_api_key" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ key_id: keyId })
        });
        
        const data = await response.json();
        if (data.success) {
            alert('âœ“ Ø§ØªØµØ§Ù„ Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯!');
            location.reload();
        } else {
            alert(`âœ— Ø®Ø·Ø§: ${data.error}`);
        }
    } catch (error) {
        alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
    }
}

function showKeyDetails(keyId) {
    // Ø§ÛŒÙ†Ø¬Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨ÛŒØ´ØªØ± Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ù‡ÛŒØ¯
    const modal = new bootstrap.Modal(document.getElementById('keyDetailsModal'));
    document.getElementById('keyDetailsContent').innerHTML = `
        <p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
    `;
    modal.show();
    
    // TODO: Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø²Ø¦ÛŒØ§Øª Ø§Ø² Ø³Ø±ÙˆØ±
}

// Ù†Ù…ÙˆØ¯Ø§Ø± Ù…ØµØ±Ù (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
document.addEventListener('DOMContentLoaded', function() {
    // Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø§ Chart.js ÛŒØ§ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ø¯ÛŒÚ¯Ø±ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø± Ø¨Ú©Ø´ÛŒØ¯
});
</script>
{% endblock %}
