{% extends "base.html" %}

{% block title %}تنظیمات API - پنل مدیریت{% endblock %}

{% block content %}
<h1 class="page-title mb-4">تنظیمات API Keys</h1>

<!-- نمایش پیام‌ها -->
{% if messages %}
<div class="mb-4">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="row">
    <div class="col-md-8">
        <!-- فرم اضافه کردن API Key -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">🔑 اضافه کردن API Key جدید</h5>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'api_settings' %}" id="apiKeyForm">
                    {% csrf_token %}
                    <input type="hidden" name="model_info" id="model_info" value="{}">
                    
                    <!-- Progress Steps -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="badge bg-primary" id="step1">1. انتخاب سرویس</span>
                            <span class="badge bg-secondary" id="step2">2. وارد کردن API Key</span>
                            <span class="badge bg-secondary" id="step3">3. دریافت مدل‌ها</span>
                            <span class="badge bg-secondary" id="step4">4. انتخاب مدل</span>
                            <span class="badge bg-secondary" id="step5">5. تست و ذخیره</span>
                        </div>
                        <div class="progress" style="height: 5px;">
                            <div class="progress-bar" id="progressBar" style="width: 20%"></div>
                        </div>
                    </div>
                    
                    <!-- Step 1: Provider Selection -->
                    <div class="mb-3">
                        <label class="form-label">انتخاب سرویس AI</label>
                        <div class="row g-3">
                            {% for provider in providers %}
                            <div class="col-md-6">
                                <div class="form-check card p-3">
                                    <input class="form-check-input" type="radio" name="provider" 
                                           value="{{ provider.id }}" data-name="{{ provider.name }}"
                                           id="provider_{{ provider.id }}" onchange="selectProvider(this)">
                                    <label class="form-check-label w-100" for="provider_{{ provider.id }}">
                                        <strong>{{ provider.get_name_display }}</strong>
                                        <br>
                                        <small class="text-muted">
                                            {% if provider.name == 'claude' %}
                                            آخرین مدل‌ها: Claude 3.5, 3.7, Opus 4, Sonnet 4
                                            {% elif provider.name == 'openai' %}
                                            GPT-4o, GPT-4 Turbo, GPT-3.5
                                            {% elif provider.name == 'gemini' %}
                                            Gemini Pro, Gemini 1.5
                                            {% elif provider.name == 'groq' %}
                                            Llama 3, Mixtral, Gemma
                                            {% elif provider.name == 'deepseek' %}
                                            DeepSeek Chat & Coder
                                            {% elif provider.name == 'github' %}
                                            GitHub Copilot Models
                                            {% endif %}
                                        </small>
                                    </label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Step 2: API Key Input -->
                    <div class="mb-3" id="apiKeySection" style="display: none;">
                        <label class="form-label">API Key</label>
                        <div class="input-group">
                            <span class="input-group-text">🔐</span>
                            <input type="password" name="api_key" id="api_key" class="form-control" 
                                   placeholder="sk-..." required>
                            <button type="button" class="btn btn-outline-secondary" onclick="toggleKeyVisibility()">
                                <i class="bi bi-eye" id="keyVisibilityIcon"></i>
                            </button>
                            <button type="button" class="btn btn-primary" onclick="fetchModels()" id="fetchModelsBtn">
                                <i class="bi bi-cloud-download"></i> دریافت مدل‌ها
                            </button>
                        </div>
                        <small class="text-muted">API Key شما به صورت امن ذخیره می‌شود</small>
                    </div>
                    
                    <!-- Step 3: Loading Models -->
                    <div class="mb-3" id="loadingSection" style="display: none;">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary mb-3"></div>
                            <p>در حال دریافت مدل‌های موجود...</p>
                        </div>
                    </div>
                    
                    <!-- Step 4: Model Selection -->
                    <div class="mb-3" id="modelSection" style="display: none;">
                        <label class="form-label">انتخاب مدل</label>
                        <div id="modelsList" class="row g-3">
                            <!-- مدل‌ها به صورت dynamic اینجا نمایش داده می‌شوند -->
                        </div>
                    </div>
                    
                    <!-- Account Info -->
                    <div id="accountInfo" class="alert alert-info d-none mb-3">
                        <h6>اطلاعات حساب:</h6>
                        <div id="accountDetails"></div>
                    </div>
                    
                    <!-- Connection Status -->
                    <div id="connectionStatus" class="alert d-none mb-3">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2 d-none" id="testingSpinner"></div>
                            <span id="statusText"></span>
                        </div>
                        <div id="statusDetails" class="mt-2 small"></div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="d-flex gap-2" id="actionButtons" style="display: none;">
                        <button type="button" class="btn btn-secondary" onclick="testConnection()" id="testBtn">
                            <i class="bi bi-plug"></i> تست اتصال
                        </button>
                        <button type="submit" class="btn btn-success" id="saveBtn" disabled>
                            <i class="bi bi-save"></i> ذخیره API Key
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- لیست API Keys -->
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0">📋 API Keys ذخیره شده</h5>
            </div>
            <div class="card-body">
                {% if user_keys %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>سرویس</th>
                                <th>مدل</th>
                                <th>وضعیت</th>
                                <th>توکن‌های مصرفی</th>
                                <th>آخرین استفاده</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for key in user_keys %}
                            <tr>
                                <td>
                                    <i class="bi bi-robot"></i>
                                    {{ key.provider.get_name_display }}
                                </td>
                                <td>
                                    <code class="small">{{ key.model_name|default:"-" }}</code>
                                </td>
                                <td>
                                    {% if key.is_active %}
                                        {% if key.is_verified %}
                                        <span class="badge bg-success">✓ فعال</span>
                                        {% else %}
                                        <span class="badge bg-warning">⚠ تست نشده</span>
                                        {% endif %}
                                    {% else %}
                                    <span class="badge bg-secondary">غیرفعال</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small>{{ key.used_tokens|floatformat:0 }} توکن</small>
                                </td>
                                <td>
                                    <small>{{ key.last_used|date:"Y/m/d H:i"|default:"هرگز" }}</small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button onclick="retestKey({{ key.id }})" 
                                                class="btn btn-outline-primary" title="تست مجدد">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                        <form method="post" action="{% url 'toggle_api_key' %}" style="display: inline;">
                                            {% csrf_token %}
                                            <input type="hidden" name="key_id" value="{{ key.id }}">
                                            <button type="submit" class="btn btn-outline-warning" 
                                                    title="{% if key.is_active %}غیرفعال{% else %}فعال{% endif %}">
                                                <i class="bi bi-toggle-{% if key.is_active %}on{% else %}off{% endif %}"></i>
                                            </button>
                                        </form>
                                        <form method="post" action="{% url 'delete_api_key' %}" 
                                              style="display: inline;" 
                                              onsubmit="return confirm('آیا از حذف این API Key مطمئن هستید؟');">
                                            {% csrf_token %}
                                            <input type="hidden" name="key_id" value="{{ key.id }}">
                                            <button type="submit" class="btn btn-outline-danger" title="حذف">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-key" style="font-size: 3rem; color: #ddd;"></i>
                    <p class="text-muted mt-3">هنوز API Key ای ذخیره نکرده‌اید</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- آمار مصرف -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0">📊 آمار مصرف این ماه</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-primary">{{ total_tokens_month|default:"0"|floatformat:0 }}</h4>
                        <small class="text-muted">توکن مصرفی</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success">${{ total_cost_month|default:"0"|floatformat:2 }}</h4>
                        <small class="text-muted">هزینه تقریبی</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- راهنما -->
        <div class="card">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">🚀 راهنمای سریع</h6>
            </div>
            <div class="card-body small">
                <h6>دریافت API Key:</h6>
                <ul class="ps-3">
                    <li><strong>Claude:</strong> <a href="https://console.anthropic.com/api" target="_blank">console.anthropic.com</a></li>
                    <li><strong>OpenAI:</strong> <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a></li>
                    <li><strong>Gemini:</strong> <a href="https://makersuite.google.com/app/apikey" target="_blank">makersuite.google.com</a></li>
                    <li><strong>Groq:</strong> <a href="https://console.groq.com/keys" target="_blank">console.groq.com</a></li>
                    <li><strong>DeepSeek:</strong> <a href="https://platform.deepseek.com/api_keys" target="_blank">platform.deepseek.com</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
// متغیرهای global
let selectedModel = null;
let currentStep = 1;
let modelsData = [];

function updateProgress(step) {
    currentStep = step;
    const progress = step * 20;
    document.getElementById('progressBar').style.width = progress + '%';
    
    for (let i = 1; i <= 5; i++) {
        const badge = document.getElementById(`step${i}`);
        if (i <= step) {
            badge.classList.remove('bg-secondary');
            badge.classList.add('bg-primary');
        } else {
            badge.classList.remove('bg-primary');
            badge.classList.add('bg-secondary');
        }
    }
}

function selectProvider(radio) {
    if (radio.checked) {
        document.getElementById('apiKeySection').style.display = 'block';
        updateProgress(2);
    }
}

function toggleKeyVisibility() {
    const input = document.getElementById('api_key');
    const icon = document.getElementById('keyVisibilityIcon');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('bi-eye');
        icon.classList.add('bi-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('bi-eye-slash');
        icon.classList.add('bi-eye');
    }
}

async function fetchModels() {
    const provider = document.querySelector('input[name="provider"]:checked');
    const apiKey = document.getElementById('api_key').value;
    
    if (!provider || !apiKey) {
        alert('لطفاً سرویس را انتخاب کرده و API Key را وارد کنید');
        return;
    }
    
    const providerName = provider.getAttribute('data-name');
    
    // Show loading
    document.getElementById('loadingSection').style.display = 'block';
    document.getElementById('modelSection').style.display = 'none';
    document.getElementById('accountInfo').classList.add('d-none');
    updateProgress(3);
    
    try {
        const response = await fetch('{% url "get_available_models" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                provider: providerName,
                api_key: apiKey
            })
        });
        
        const data = await response.json();
        
        document.getElementById('loadingSection').style.display = 'none';
        
        if (data.success) {
            modelsData = data.models;
            displayModels(data.models);
            updateProgress(4);
            
            // نمایش اطلاعات حساب
            if (data.account_info && Object.keys(data.account_info).length > 0) {
                showAccountInfo(data.account_info, providerName);
            }
        } else {
            alert(`خطا: ${data.error}`);
            updateProgress(2);
        }
    } catch (error) {
        document.getElementById('loadingSection').style.display = 'none';
        alert('خطا در ارتباط با سرور: ' + error);
        updateProgress(2);
    }
}

function displayModels(models) {
    const modelsList = document.getElementById('modelsList');
    const modelSection = document.getElementById('modelSection');
    
    modelsList.innerHTML = '';
    
    models.forEach((model, index) => {
        const available = model.available !== false;
        
        const card = document.createElement('div');
        card.className = 'col-md-6';
        card.innerHTML = `
            <div class="card ${available ? '' : 'opacity-50'}" style="cursor: ${available ? 'pointer' : 'not-allowed'};">
                <div class="card-body">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="model_name" 
                               value="${model.id}" id="model_${index}"
                               ${available ? '' : 'disabled'}
                               onchange="selectModel('${model.id}', ${index})">
                        <label class="form-check-label w-100" for="model_${index}">
                            <strong>${model.name || model.id}</strong>
                            ${model.description ? `<br><small class="text-muted">${model.description}</small>` : ''}
                            <div class="mt-2">
                                ${model.context_window ? `<span class="badge bg-secondary">Context: ${model.context_window.toLocaleString()}</span>` : ''}
                                ${model.features ? model.features.map(f => `<span class="badge bg-info ms-1">${f}</span>`).join('') : ''}
                                ${!available ? '<span class="badge bg-danger ms-1">غیرقابل دسترس</span>' : ''}
                            </div>
                            ${model.pricing ? `
                            <div class="mt-1">
                                <small class="text-muted">
                                    Input: $${model.pricing.input}/1M | Output: $${model.pricing.output}/1M
                                </small>
                            </div>
                            ` : ''}
                        </label>
                    </div>
                </div>
            </div>
        `;
        modelsList.appendChild(card);
    });
    
    modelSection.style.display = 'block';
    document.getElementById('actionButtons').style.display = 'flex';
}

function selectModel(modelId, modelInfo) {
    selectedModel = JSON.parse(decodeURIComponent(modelInfo));
    document.getElementById("model_info").value = JSON.stringify(selectedModel);
    updateProgress(5);
}

function showAccountInfo(accountInfo, providerName) {
    const accountDiv = document.getElementById('accountInfo');
    const accountDetails = document.getElementById('accountDetails');
    
    let details = '';
    
    if (accountInfo.api_key_valid) {
        details += `<p class="mb-1"><strong>وضعیت API Key:</strong> <span class="text-success">✓ معتبر</span></p>`;
    }
    
    if (accountInfo.organization) {
        details += `<p class="mb-1"><strong>سازمان:</strong> ${accountInfo.organization}</p>`;
    }
    
    if (accountInfo.usage_info) {
        if (accountInfo.usage_info.subscription) {
            const sub = accountInfo.usage_info.subscription;
            details += `<p class="mb-1"><strong>طرح:</strong> ${sub.plan?.title || 'نامشخص'}</p>`;
            if (sub.hard_limit_usd) {
                details += `<p class="mb-1"><strong>محدودیت:</strong> $${sub.hard_limit_usd}</p>`;
            }
        }
        
        if (accountInfo.usage_info.usage) {
            const usage = accountInfo.usage_info.usage;
            details += `<p class="mb-1"><strong>مصرف این ماه:</strong> $${(usage.total_usage || 0).toFixed(2)}</p>`;
        }
    }
    
    if (accountInfo.rate_limits) {
        details += `<p class="mb-1"><strong>محدودیت نرخ:</strong> ${accountInfo.rate_limits}</p>`;
    }
    
    if (!details) {
        details = '<p class="mb-0 text-muted">اطلاعات حساب موجود نیست</p>';
    }
    
    accountDetails.innerHTML = details;
    accountDiv.classList.remove('d-none');
}

async function testConnection() {
    const provider = document.querySelector('input[name="provider"]:checked')?.value;
    const apiKey = document.getElementById('api_key').value;
    const modelName = document.querySelector('input[name="model_name"]:checked')?.value;
    
    if (!provider || !apiKey || !modelName) {
        alert('لطفاً همه مراحل را تکمیل کنید');
        return;
    }
    
    const statusDiv = document.getElementById('connectionStatus');
    const statusText = document.getElementById('statusText');
    const statusDetails = document.getElementById('statusDetails');
    const spinner = document.getElementById('testingSpinner');
    const saveBtn = document.getElementById('saveBtn');
    
    // Show testing status
    statusDiv.className = 'alert alert-info';
    statusDiv.classList.remove('d-none');
    spinner.classList.remove('d-none');
    statusText.textContent = 'در حال تست اتصال...';
    statusDetails.innerHTML = '';
    
    try {
        const response = await fetch('{% url "test_api_connection" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                provider: provider,
                api_key: apiKey,
                model_name: modelName
            })
        });
        
        const data = await response.json();
        spinner.classList.add('d-none');
        
        if (data.success) {
            statusDiv.className = 'alert alert-success';
            statusText.innerHTML = '✓ اتصال موفق!';
            
            let details = '<strong>جزئیات تست:</strong><br>';
            details += `مدل: ${data.model}<br>`;
            
            if (data.usage) {
                details += `توکن‌های تست: ${data.usage.total_tokens || 0}<br>`;
                if (data.usage.estimated_cost) {
                    details += `هزینه تست: ${data.usage.estimated_cost}<br>`;
                }
            }
            
            if (data.limits) {
                if (data.limits.context_window) {
                    details += `Context Window: ${data.limits.context_window.toLocaleString()}<br>`;
                }
            }
            
            if (data.features && data.features.length > 0) {
                details += `ویژگی‌ها: ${data.features.join(', ')}<br>`;
            }
            
            statusDetails.innerHTML = details;
            saveBtn.disabled = false;
        } else {
            statusDiv.className = 'alert alert-danger';
            statusText.textContent = `✗ خطا: ${data.error}`;
            saveBtn.disabled = true;
        }
    } catch (error) {
        spinner.classList.add('d-none');
        statusDiv.className = 'alert alert-danger';
        statusText.textContent = '✗ خطا در ارتباط با سرور: ' + error;
        saveBtn.disabled = true;
    }
}

async function retestKey(keyId) {
    if (!confirm('آیا می‌خواهید این API Key را مجدداً تست کنید؟')) return;
    
    try {
        const response = await fetch('{% url "retest_api_key" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ key_id: keyId })
        });
        
        const data = await response.json();
        if (data.success) {
            alert('✓ اتصال موفق بود!');
            location.reload();
        } else {
            alert(`✗ خطا: ${data.error}`);
        }
    } catch (error) {
        alert('خطا در ارتباط با سرور');
    }
}

// تابع کمکی برای دریافت CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
