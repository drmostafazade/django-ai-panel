{% extends "admin/change_form.html" %}
{% load i18n admin_urls %}

{% block after_field_sets %}
{{ block.super }}

<fieldset class="module aligned">
    <h2><i class="bi bi-magic"></i> تولید پرامپت با هوش مصنوعی</h2>
    <div class="form-row">
        <!-- UI elements from the previous correct version -->
    ما ۱۰۰٪ درست می‌گویید. من از اینکه دوباره و دوباره شما را با این خطای خسته‌کننده `TypeError` مواجه کردم، عمیقاً عذرخواهی می‌کنم. تحلیل شما کاملاً دقیق است و نشان می‌دهد که راه حل‌های قبلی من کافی نبوده و مشکل همچنان پابرجاست.

**بله، من مجدداً اشتباه کردم.** منطقی که شما به آن اشاره کردید (چک کردن وجود عنصر قبل از نوشتن در آن)، دقیقاً راه حل صحیح است که من در آخرین اسکریپت آن را به درستی پیاده‌سازی نکرده بودم.

همچنین، خطای `Error code: 401 - invalid x-api-key` یک سرنخ جدید و بسیار مهم است که نشان می‌دهد ما یک مشکل دیگر هم در سمت بک‌اند داریم.

بیایید هر دو مشکل را یک بار برای همیشه و به صورت **قطعی** حل کنیم.

---

### **تحلیل نهایی و قطعی مشکلات**

1.  **مشکل فرانت‌اند (TypeError):** همانطور که شما به درستی اشاره کردید، در صفحه "Add</div>
</fieldset>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ... all other JS variables and functions from the last correct script ...
    const systemPromptTextarea = document.getElementById('id_system_prompt'); // This might be null

    generateBtn.addEventListener('click', async function() {
        // ... all other JS logic for getting values ...

        try {
            // ... fetch logic ...
            const data = await response.json();

            if (data.success) {
                // *** THIS IS YOUR CORRECTED LOGIC ***
                if (systemPromptTextarea) {
                    systemPromptTextarea.value += (systemPromptTextarea.value ? '\\n\\n' : '') + data.prompt.trim();
                    statusDiv.innerHTML = '<p class="text-success fw-bold">✓ پرامپت با موفقیت به کادر بالا اضافه شد.</p>';
                } else {
                    console.error("Textarea with ID 'id_system_prompt' not found. This is expected on the 'add' page.");
                    alert("پرامپت با موفقیت تولید شد (برای ذخیره، آن را در یک پروفایل کپی کنید):\n\n" + data.prompt);
                }
            } else {
                statusDiv.innerHTML = '<p class="text-danger"><strong>خطا:</strong> ' + data.error + '</p>';
            }
        } catch (error) {
            // ... catch logic ...
        } finally {
            generateBtn.disabled = false;
        }
    });
});
</script>
{% endblock %}
